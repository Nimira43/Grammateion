import{H3Event as r,getRequestURL as i,getResponseStatus as c,getRequestWebStream as f}from"h3";import{getContext as p}from"unctx";import{AsyncLocalStorage as g}from"node:async_hooks";function l(e){let n;const t=u(e),s={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(t,{...s,body:e.node.req.body}):new Request(t,{...s,get body(){return n||(n=m(e),n)}})}function y(e){return e.web??={request:l(e),url:u(e)},e.web.request}function b(){return q()}const a=Symbol("$HTTPEvent");function h(e){return typeof e=="object"&&(e instanceof r||e?.[a]instanceof r||e?.__is_event__===!0)}function o(e){return function(...n){let t=n[0];if(h(t))n[0]=t instanceof r||t.__is_event__?t:t[a];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(t=b(),!t)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");n.unshift(t)}return e(...n)}}const u=o(i),T=o(c),m=o(f),w=o(y);function R(){return p("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:g})}function q(){return R().use().event}export{q as a,w as b,T as g,y as t};
